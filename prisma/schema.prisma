generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?
  passwordHash  String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  strategies    Strategy[]
  backtests     Backtest[]
  ideations     Ideation[]
  subscriptions Subscription[]

  accounts      Account[]
  sessions      Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum StrategyType {
  STRATEGY
  INDICATOR
}

model Strategy {
  id          String       @id @default(cuid())
  userId      String
  name        String
  description String?      @db.Text
  pineCode    String       @db.Text
  type        StrategyType @default(STRATEGY)
  isPublic    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  backtests Backtest[]

  @@index([userId])
}

model Backtest {
  id             String   @id @default(cuid())
  userId         String
  strategyId     String?
  name           String
  symbol         String
  timeframe      String
  startDate      DateTime
  endDate        DateTime
  initialCapital Float

  totalReturn  Float
  sharpeRatio  Float?
  maxDrawdown  Float
  winRate      Float
  profitFactor Float?
  totalTrades  Int

  tradesJson      Json
  equityCurveJson Json
  monteCarloJson  Json?

  createdAt DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy Strategy? @relation(fields: [strategyId], references: [id])

  @@index([userId])
  @@index([strategyId])
}

model Ideation {
  id                 String   @id @default(cuid())
  userId             String
  featureDescription String   @db.Text
  symbol             String
  timeframe          String

  icMean             Float?
  icIr               Float?
  pValue             Float?
  isSignificant      Boolean?
  mlAccuracy         Float?
  hasPredictivePower Boolean?

  resultsJson Json?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Subscription {
  id                     String             @id @default(cuid())
  userId                 String
  stripeCustomerId       String?            @unique
  stripeSubscriptionId   String?            @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  status                 SubscriptionStatus @default(INACTIVE)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
  CANCELED
}

model StrategyLibrary {
  id           String   @id @default(cuid())
  name         String
  description  String   @db.Text
  category     String
  pineCode     String   @db.Text
  author       String?
  votes        Int      @default(0)
  isInfluencer Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

